# Tala API Gateway - Nginx Configuration
# Routes frontend requests to appropriate backend microservices

upstream user-service {
    server user-service:8081;
}

upstream event-service {
    server event-service:8082;
}

upstream query-service {
    server query-service:8083;
}

upstream personalization-service {
    server personalization-service:8084;
}

upstream ai-service {
    server ai-service:8085;
}

upstream reminder-service {
    server reminder-service:8086;
}

upstream media-service {
    server media-service:8087;
}

upstream file-service {
    server file-service:8088;
}

server {
    listen 8080;
    server_name localhost;
    
    # Logging
    access_log /var/log/nginx/tala-api-access.log;
    error_log /var/log/nginx/tala-api-error.log warn;
    
    # CORS Configuration
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With" always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Max-Age 3600 always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        return 204;
    }
    
    # Health check endpoint
    location /health {
        access_log off;
        return 200 '{"status":"healthy","service":"api-gateway"}';
        add_header Content-Type application/json;
    }
    
    # ============================================
    # User Service Routes (Port 8081)
    # ============================================
    
    # Authentication
    location /api/v1/auth {
        proxy_pass http://user-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Profiles
    location /api/v1/profiles {
        proxy_pass http://user-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Interests
    location /api/v1/interests {
        proxy_pass http://user-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ============================================
    # Event Service Routes (Port 8082)
    # ============================================
    
    location /api/v1/events {
        proxy_pass http://event-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ============================================
    # Query Service Routes (Port 8083)
    # ============================================
    
    location /api/v1/analytics {
        proxy_pass http://query-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location /api/v1/daily-summaries {
        proxy_pass http://query-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ============================================
    # Personalization Service Routes (Port 8084)
    # ============================================
    
    location /api/v1/personalization {
        proxy_pass http://personalization-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ============================================
    # AI Service Routes (Port 8085)
    # ============================================
    
    location /api/v1/ai {
        proxy_pass http://ai-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Longer timeout for AI operations
        proxy_read_timeout 300s;
        proxy_connect_timeout 300s;
    }
    
    # ============================================
    # Reminder Service Routes (Port 8086)
    # ============================================
    
    location /api/v1/reminders {
        proxy_pass http://reminder-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ============================================
    # Media Service Routes (Port 8087)
    # ============================================
    
    location /api/v1/media {
        proxy_pass http://media-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Larger body size for media uploads
        client_max_body_size 50M;
    }
    
    # ============================================
    # File Service Routes (Port 8088)
    # ============================================
    
    location /api/v1/files {
        proxy_pass http://file-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Larger body size for file uploads
        client_max_body_size 100M;
    }
    
    # ============================================
    # Actuator Endpoints (Health Checks)
    # ============================================
    
    location /actuator {
        # Route to user-service by default
        proxy_pass http://user-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # ============================================
    # Default / Catch-all
    # ============================================
    
    location / {
        return 404 '{"error":"Not Found","message":"Invalid API endpoint"}';
        add_header Content-Type application/json;
    }
}
